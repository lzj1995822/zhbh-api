<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jtzh.mapper.OrgMemberServedPersonRecordMapper">
    <resultMap id="BaseResultMap" type="com.jtzh.entity.OrgMemberServedPersonRecord">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. -->
        <id column="OrgMServedPID" jdbcType="BIGINT" property="orgMServedPID"/>
        <result column="OrgMemberID" jdbcType="BIGINT" property="orgMemberID"/>
        <result column="ServedPersonID" jdbcType="BIGINT" property="servedPersonID"/>
        <result column="ServerInf" jdbcType="VARCHAR" property="serverInf"/>
        <result column="ServerDate" jdbcType="DATE" property="serverDate"/>
    </resultMap>

    <resultMap id="ServedRecordCountVO" type="com.jtzh.vo.orgMember.ServedRecordCountVO">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. -->
        <result column="ServerDate" jdbcType="VARCHAR" property="date"/>
        <result column="count" jdbcType="INTEGER" property="count"/>
    </resultMap>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. -->
        delete from TROrgMemberServedPersonRecord
        where OrgMServedPID =
        #{orgMServedPID,jdbcType=BIGINT}
    </delete>
    <insert id="insert" parameterType="com.jtzh.entity.OrgMemberServedPersonRecord"
            keyProperty="orgMServedPID" useGeneratedKeys="true">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. -->
        insert into TROrgMemberServedPersonRecord (OrgMServedPID, OrgMemberID,
        ServedPersonID,
        ServerInf, ServerDate)
        values
        (#{orgMServedPID,jdbcType=BIGINT}, #{orgMemberID,jdbcType=BIGINT},
        #{servedPersonID,jdbcType=BIGINT},
        #{serverInf,jdbcType=VARCHAR},
        #{serverDate,jdbcType=DATE})
    </insert>
    <update id="updateByPrimaryKey" parameterType="com.jtzh.entity.OrgMemberServedPersonRecord">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. -->
        update TROrgMemberServedPersonRecord
        set OrgMemberID =
        #{orgMemberID,jdbcType=BIGINT},
        ServedPersonID =
        #{servedPersonID,jdbcType=BIGINT},
        ServerInf =
        #{serverInf,jdbcType=VARCHAR},
        ServerDate = #{serverDate,jdbcType=DATE}
        where OrgMServedPID = #{orgMServedPID,jdbcType=BIGINT}
    </update>
    <update id="updateRecord">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. -->
        update TROrgMemberServedPersonRecord
        set
        ServerInf =
        #{content},
        ServerDate = #{date}
        where OrgMServedPID = #{id}
    </update>
    <select id="selectByPrimaryKey" parameterType="java.lang.Long"
            resultMap="BaseResultMap">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. -->
        select OrgMServedPID, OrgMemberID, ServedPersonID, ServerInf,
        ServerDate
        from TROrgMemberServedPersonRecord
        where OrgMServedPID =
        #{orgMServedPID,jdbcType=BIGINT}
    </select>
    <select id="selectAll" resultMap="BaseResultMap">
        <!-- WARNING - @mbg.generated This element is automatically generated by
            MyBatis Generator, do not modify. -->
        select OrgMServedPID, OrgMemberID, ServedPersonID, ServerInf,
        ServerDate
        from TROrgMemberServedPersonRecord
    </select>
    <resultMap id="OrgMemberServedPersonRecordQueryVOResultMap"
               type="com.jtzh.vo.orgMember.OrgMemberServedPersonRecordQueryVO">
        <id column="OrgMServedPID" jdbcType="BIGINT" property="orgMServedPID"/>
        <result column="OrgMemberName" jdbcType="VARCHAR" property="orgMemberName"/>
        <result column="ServedPersonName" jdbcType="VARCHAR" property="servedPersonName"/>
        <result column="ServerInf" jdbcType="VARCHAR" property="serverInf"/>
        <result column="ServerDate" jdbcType="VARCHAR" property="serverDate"/>
    </resultMap>


    <resultMap id="ServedRecordDetailVO" type="com.jtzh.vo.orgMember.ServedRecordDetailVO">
        <result column="OrgMemberName" jdbcType="VARCHAR" property="orgMemberName"/>
        <result column="ServedPersonName" jdbcType="VARCHAR" property="servedPersonName"/>
        <result column="ServerInf" jdbcType="VARCHAR" property="serverInf"/>
        <result column="ServerDate" jdbcType="VARCHAR" property="serverDate"/>
    </resultMap>
    <resultMap id="ServedRecordVO" type="com.jtzh.vo.gis.ServedRecordVO">
        <id column="OrgMServedPID" jdbcType="BIGINT" property="orgMServedPID"/>
        <result column="OrgMemberName" jdbcType="VARCHAR" property="orgMemberName"/>
        <result column="ServedPersonName" jdbcType="VARCHAR" property="servedPersonName"/>
        <result column="ServerInf" jdbcType="VARCHAR" property="serverInf"/>
        <result column="ServerDate" jdbcType="VARCHAR" property="serverDate"/>
        <result column="Longitude" jdbcType="DOUBLE" property="longitude"/>
        <result column="Latitude" jdbcType="DOUBLE" property="latitude"/>

    </resultMap>

    <select id="getDetailByID" resultMap="ServedRecordDetailVO">
		SELECT t2.Name as
		OrgMemberName,t3.Name as
		ServedPersonName,t1.ServerInf,t1.ServerDate
		FROM
		TROrgMemberServedPersonRecord t1 left join
		TEOrgMember
		t2 on
		t1.OrgMemberID=t2.OrgMemberID left join
		TEServedPersonBasic t3
		on
		t1.ServedPersonID=t3.ServedPersonID
		where
		OrgMServedPID=#{orgMServedPID}
	</select>
    <select id="getServedRecordForGIS" resultMap="ServedRecordVO">
        SELECT OrgMServedPID,t2.Name as
        OrgMemberName,t3.Name as
        ServedPersonName,t1.ServerInf,t1.ServerDate,t5.Longitude,t5.Latitude
        FROM
        TROrgMemberServedPersonRecord t1 left join
        TEOrgMember
        t2 on
        t1.OrgMemberID=t2.OrgMemberID left join
        TEServedPersonBasic t3
        on
        t1.ServedPersonID=t3.ServedPersonID
        left join TRPersonHouse t4
        on
        t1.ServedPersonID=t4.ServedPersonID
        left join TEHouse t5
        on
        t4.HouseID=t5.HouseID
        left join TEServedPersonBasic t6
        on
        t1.ServedPersonID=t6.ServedPersonID
        where 1=1
        <if test="netGridID != null and netGridID != 0 ">
            and t6.NetGridID=#{netGridID}
        </if>
    </select>

    <select id="select" resultMap="OrgMemberServedPersonRecordQueryVOResultMap">
        SELECT OrgMServedPID,t2.Name as OrgMemberName,t3.Name as
        ServedPersonName,t1.ServerInf,t1.ServerDate FROM
        TROrgMemberServedPersonRecord t1 left join
        TENetGridMember t2 on
        t1.OrgMemberID=t2.NetGridMemberID left join
        TEServedPersonBasic t3
        on
        t1.ServedPersonID=t3.ServedPersonID
        where 1=1
        <if test="orgMemberName != null and orgMemberName != '' ">
            and t2.Name LIKE CONCAT(CONCAT('%', #{orgMemberName}), '%')
        </if>
        <if test="servedPersonName != null and servedPersonName != ''">
            and t3.Name LIKE CONCAT(CONCAT('%', #{servedPersonName}),
            '%')
        </if>
        <if test="netGridID != null and netGridID != 0 ">
            and t3.NetGridID=#{netGridID}
        </if>
        limit #{start},#{pageSize}
    </select>

    <select id="getQueryCount" resultType="java.lang.Integer">

        select count(*)
        from TROrgMemberServedPersonRecord t1 left join
        TEOrgMember t2 on
        t1.OrgMemberID=t2.OrgMemberID left join
        TEServedPersonBasic t3
        on
        t1.ServedPersonID=t3.ServedPersonID
        where 1=1
        <if test="orgMemberName != null and orgMemberName != '' ">
            and t2.Name LIKE CONCAT(CONCAT('%', #{orgMemberName}), '%')
        </if>
        <if test="servedPersonName != null and servedPersonName != ''">
            and t3.Name LIKE CONCAT(CONCAT('%', #{servedPersonName}),
            '%')
        </if>
        <if test="netGridID != null and netGridID != 0 ">
            and t3.NetGridID=#{netGridID}
        </if>
    </select>

    <select id="getServedRecordCount" resultMap="ServedRecordCountVO">
		SELECT
		ServerDate,count(*) count FROM TROrgMemberServedPersonRecord where
		YEARWEEK(date_format(ServerDate,'%Y-%m-%d')) =YEARWEEK(now()) group by
		ServerDate;
	</select>

    <!--服务对象人数 -->
    <select id="getEveryMonthPersonCount" resultType="java.lang.Integer">
		SELECT
		count(distinct ServedPersonID) FROM TROrgMemberServedPersonRecord
		where DATE_FORMAT(ServerDate,'%Y-%m') =
		DATE_FORMAT(CURDATE(),'%Y-%m');
	</select>

    <!--累计服务人数 -->
    <select id="getServedCount" resultType="java.lang.Integer">
		SELECT
		count(distinct
		ServedPersonID) FROM TROrgMemberServedPersonRecord;
	</select>

    <!--本月服务记录 -->
    <select id="getCurrentMonthCount" resultMap="ServedRecordCountVO">
		select
		t.ServedPersonTypeValue ServerDate,ifnull(ta.c,0) Count from
		TECODEServedPersonType t
		left join
		(SELECT t3.ServedPersonTypeValue
		v,count(distinct
		t1.ServedPersonID) c FROM
		TROrgMemberServedPersonRecord t1
		left join
		TEServedPersonBasic t2 on
		t1.ServedPersonID=t2.ServedPersonID
		left join
		TECODEServedPersonType t3
		on
		t2.ServedPersonTypeValue=t3.ServedPersonTypeValue
		where
		DATE_FORMAT(t1.ServerDate,'%Y-%m') = DATE_FORMAT(CURDATE(),'%Y-%m')
		group by t3.ServedPersonTypeValue) ta
		on t.ServedPersonTypeValue=ta.v;
	</select>


</mapper>